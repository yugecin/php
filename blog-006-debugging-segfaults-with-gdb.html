<!DOCTYPE html>
<html lang=en>
<head>
	<meta charset=utf-8>
	<title>debugging segfaults with gdb</title>
	<link rel=stylesheet href=default.css?v5 type=text/css>
</head>
<body>
	<div>
		<nav>
			<p>
				<a href=index.html>home/about</a>
				|
				<a href=projects.html>projects</a>
				|
				<a href=blog.html>blog</a>
				|
				<a href=demoscene.html>demoscene</a>
				|
				<a href=random.html>random</a>
		</nav>
		<hr/>
		<p>
			<a href=blog.html>blog</a>
			&gt;
			debugging segfaults with gdb (7 Dec 2025)
		<h1>
			debugging segfaults with gdb
		</h1>
		<p>
			This "blogpost" is mainly just a reference/tutorial for my future self for
			when I'll have forgotten how to use gdb again.
		<p>
			I started using gdb to debug segfaults that occur on
			<a href=projects.html#basdon-fly>basdon, my gta:sa-mp server</a>,
			which runs using things that I wrote in C.

		<h2 id=ensuringsymbolspresent>
			Ensuring symbols are present <a href=#ensuringsymbolspresent>#</a>
		</h2>
		<code>plugins/basdonfly.so</code> is my plugin for the samp server, which is
		built with gcc using <code>-ggdb</code> to try to ensure enough debug information
		is present.

		<h2 id=enablingcoredumps>
			Enabling coredumps <a href=#enablingcoredumps>#</a>
		</h2>
		<p>
			I initially didn't get coredumps, so I had to execute
			<code>ulimit -c unlimited</code>. Maybe "unlimited" should be some sane value
			instead, but it works and I'm too lazy now. I also read that this is not
			persistent, so I simply run this command right before starting the sa:mp server
			every time.
		<p>
			With this configuration, I now get <code>core.PID</code> files on segfaults,
			where <code>PID</code> is the process id. They are placed in the working directory.
			I've also read somewhere - I think - that there may be a standard path set where
			these files will be put, but it's not like that in my case.

		<h2 id=launchinggdb>
			Launching gdb <a href=#launchinggdb>#</a>
		</h2>
<pre>
gdb /basdon-fly/server/samp03svr -c core.8492
</pre>
		<ul>
			<li>
				<code>/basdon-fly/server/samp03svr</code> is the samp server, a binary that I
				did not build nor have debug symbols for.
			<li>
				<code>-c core.8492</code> is the core dump file.
		</ul>
		<div>
			<p>
				I'm not sure what the correct program argument is, should it be the server executable
				or my plugin shared library? It does not seem to matter much, but there has to be a
				program argument or it doesn't show much.
			<ul>
				<li>
					When using <code>/basdon-fly/server/plugins/basdonfly.so</code> instead of
					<code>samp03svr</code>, the only difference that I can spot is that <code>bt</code>
					shows a few (6) more calls, but they're all near the bottom of the stack and they
					don't resolve to a known procedure so it doesn't help me much.
				<li>
					When omitting the program argument as a whole and only launching with a core file,
					gdb is unable to even show a backtrace and finds no types at all
			</ul>
		</div>
		<p>
			A quick <code>info sharedlibrary</code> should confirm that my plugin library was loaded and included symbols and debug info:
<pre>
(gdb) info sharedlibrary
From        To          Syms Read   Shared Object Library
                        No          /lib/libdl.so.2
                        No          /lib/libpthread.so.0
                        No          /lib/libstdc++.so.6
                        No          /lib/libm.so.6
                        No          /lib/libgcc_s.so.1
                        No          /lib/libc.so.6
0xf76f7058  0xf77124d3  Yes (*)     /lib/ld-linux.so.2
                        No          plugins/mysql-r39-3-static.so
                        No          /lib/librt.so.1
                        No          /lib/libnss_files.so.2
                        No          plugins/bcrypt-v2.2-debian7.so
                        No          plugins/simplesocket.so
0xf633aa00  0xf635bdd3  Yes         plugins/basdonfly.so
(*): Shared library is missing debugging information.
</pre>

		<h2 id=notecommandshortening>
			A note on command shortening <a href=#notecommandshortening>#</a>
		</h2>
		<p>
			gdb finds commands using a "starts with" match, so
			<code>info locals</code> could be shortened by doing
			<code>i lo</code>.
		<p>
			If a command would be ambiguous, gdb will tell you.

		<h2 id=lookingaround>
			Looking around <a href=#lookingaround>#</a>
		</h2>
		<p>
			At launch, gdb will already show the crash site.
<pre>
Core was generated by `./samp03svr'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  spawn_get_random_spawn (playerid=playerid@entry=0,
outSpawnInfo=outSpawnInfo@entry=0xffd0c9a2) at spawn.c:118
118             memcpy(&amp;outSpawnInfo-&gt;pos, spawns[klass] + spawnidx, sizeof(struct vec4));
[Current thread is 1 (LWP 8492)]
</pre>
		<p>
			<code>bt</code> shows a backtrace
<pre>
(gdb) bt
#0  spawn_get_random_spawn (playerid=playerid@entry=0, outSpawnInfo=outSpawnInfo@entry=0xffd0c9a2) at spawn.c:118
#1  0xf6348338 in natives_SpawnPlayer (playerid=playerid@entry=0) at samp.c:1443
#2  0xf6357cc3 in missions_cleanup (playerid=playerid@entry=0) at missions.c:820
#3  0xf6357e92 in missions_end_unfinished (playerid=playerid@entry=0, reason=reason@entry=1024) at missions.c:863
#4  0xf6357f5b in missions_on_vehicle_destroyed_or_respawned (vehicleid=vehicleid@entry=97) at missions.c:920
#5  0xf6357b8e in veh_DestroyVehicle (vehicleid=vehicleid@entry=97) at vehicles.c:1132
#6  0xf6359940 in B_OnVehicleSpawn (amx=0x84929d8, params=0xf63fd6a8 &lt;fakeamx+24712&gt;) at basdonfly_callbacks.c:485
#7  0x08096a07 in ?? ()
#8  0x080a53b9 in ?? ()
#9  0x0814b674 in ?? ()
#10 0x0814cd5f in ?? ()
#11 0x080af078 in ?? ()
#12 0x080aa13a in ?? ()
#13 0xf73d91b3 in ?? ()
</pre>
		<p>
			The frames in the backtrace are numbered, that number can be used to change
			the current context with <code>frame &lt;number&gt;</code>
<pre>
(gdb) frame 1
#1  0xf6348338 in natives_SpawnPlayer (playerid=playerid@entry=0) at samp.c:1443
warning: Source file is more recent than executable.
1443            spawn_get_random_spawn(playerid, &amp;spawnInfo);
</pre>
		<p>
			<code>info locals</code> shows local variables in the current frame
<pre>
(gdb) info locals
spawnInfo = {team = 11 '\v', skin = -13156097, _pad5 = 69 'E', pos = {coords = {x = -nan(0x50c9b8), y = 4.2606904e-34,
    z = 5.95649804e-34}, r = 1.35925951e-43}, weapon = {1764247626, -164267066, 139012568}, ammo = {-163641248, 8, 0}}
</pre>
		<p>
			<code>info args</code> shows the arguments that were passed for
			the proc in the current frame
<pre>
(gdb) info args
playerid = 0
</pre>
		<p>
			<code>print &lt;expression&gt;</code> evaluates an expression. This can reference
			global and local variables, arguments, ...
<pre>
(gdb) p player[playerid]-&gt;pos
$9 = {x = -15495.7988, y = 11682.5537, z = -1.38694525}
</pre>
		<p>
			<code>info types</code> shows all known types (includes typedefs and structures)
		<p>
			<code>info</code> shows all info subcommands
		<p>
			<code>ptype &lt;name&gt;</code> shows a type definition
<pre>
(gdb) ptype struct STREAMING_DATA
type = struct STREAMING_DATA {
    struct OBJECT_MAP *obj_map;
    struct RPCDATA_CreateObject *queued_objects[900];
    short num_queued_objects;
    struct ZONE_MAP *zone_map;
    short next_zone_idx;
}

(gdb) ptype enum OBJ_STREAM_MODE
type = enum OBJ_STREAM_MODE {OBJ_STREAM_MODE_ANY, OBJ_STREAM_MODE_CLOSEST_NOW}
</pre>

		<footer>
			<p>
				published: 07 December 2025
		</footer>
	</div>
</body>
</html>
